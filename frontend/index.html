<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Solana Auto Flywheel — Durable Connect</title>
  <style>
    :root { --bg:#0c0b10; --card:#151320; --text:#fff; --muted:#a9a6bb; --pri:#8b5cf6; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 70% -10%, #221a3d 0%, #0c0b10 60%);color:var(--text);font:16px/1.35 Inter,system-ui,Arial}
    #status{background:#0b1220;border-bottom:1px solid rgba(255,255,255,.08);padding:10px 16px;font-size:13px;display:flex;gap:12px;align-items:center}
    #status .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#ef4444}
    #status.ok .dot{background:#22c55e}
    #status .warn .dot{background:#f59e0b}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);position:sticky;top:0;z-index:9999}
    .brand{display:flex;gap:12px;align-items:center}
    .nav{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--pri);color:#fff}
    .btn.secondary{background:#334155;color:#fff}
    .container{max-width:980px;margin:30px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;margin-top:16px}
    .hidden{display:none}
    #connectBtn { position: relative !important; z-index: 99999 !important; pointer-events: auto !important; }
    #openTopBtn { display:none }
    iframe-warning{ display:block; }
  </style>
</head>
<body>
  <div id="status"><span class="dot"></span><span id="status-text">Checking wallet…</span><span id="ctx" style="margin-left:auto;opacity:.8;font-size:12px"></span></div>

  <header class="topbar">
    <div class="brand"><h1>Solana Auto Buy &amp; Burn</h1></div>
    <nav class="nav">
      <button id="connectBtn" class="btn primary">Connect Wallet</button>
      <button id="openTopBtn" class="btn secondary">Open in new tab</button>
    </nav>
  </header>

  <main class="container">
    <div class="card">
      <div><b>Debug:</b> <span id="debug-line">—</span></div>
      <div style="margin-top:8px;font-size:13px;opacity:.85">
        If the connect button doesn’t react, click <b>Open in new tab</b>. Some browsers/extensions don’t inject the wallet into iframes or preview sandboxes.
      </div>
    </div>
  </main>

  <script>
    (function(){
      const DEV_WALLET = "CVP42X734KgiToYKSWLYfmZ8ULvRLycExPyCV6jR3FWm";

      const $ = (id) => document.getElementById(id);
      const short = (k) => k ? k.slice(0,4)+"…"+k.slice(-4) : "";

      let provider = null;
      let connectedPubkey = null;
      let tries = 0;
      const maxTries = 50; // ~10s at 200ms

      function inIframe(){
        try { return window.self !== window.top; } catch { return true; }
      }

      function setStatus(kind, text){
        const s = $("#status");
        s.classList.remove("ok","warn");
        if (kind === "ok") s.classList.add("ok");
        else if (kind === "warn") s.classList.add("warn");
        $("#status-text").textContent = text;
        $("#ctx").textContent = inIframe() ? "context: iframe" : "context: top";
      }

      function getProvider(){
        if (window?.solana?.isPhantom) return window.solana;
        if (window?.phantom?.solana?.isPhantom) return window.phantom.solana;
        return null;
      }

      function wireEvents(p){
        if (!p || p._wired) return; p._wired = true;
        p.on?.("connect", (k)=>{
          const pk = k?.toString?.() || p.publicKey?.toString?.() || null;
          if (pk){
            connectedPubkey = pk;
            $("#connectBtn").textContent = short(pk);
            $("#debug-line").textContent = "event: connect " + pk;
            setStatus("ok", "Connected: " + short(pk));
          }
        });
        p.on?.("disconnect", ()=>{
          connectedPubkey = null;
          $("#connectBtn").textContent = "Connect Wallet";
          $("#debug-line").textContent = "event: disconnect";
          setStatus("", "Not connected");
        });
        p.on?.("accountChanged", (k)=>{
          const pk = k?.toString?.() || p.publicKey?.toString?.() || null;
          connectedPubkey = pk;
          $("#connectBtn").textContent = pk ? short(pk) : "Connect Wallet";
          $("#debug-line").textContent = "event: accountChanged " + (pk || "—");
          setStatus(pk ? "ok" : "", pk ? ("Connected: " + short(pk)) : "Not connected");
        });
      }

      async function pollProvider(){
        tries++;
        provider = getProvider();
        if (provider){
          $("#debug-line").textContent = "Provider: FOUND";
          wireEvents(provider);
          if (provider.publicKey){
            const pk = provider.publicKey.toString();
            connectedPubkey = pk;
            $("#connectBtn").textContent = short(pk);
            setStatus("ok", "Connected: " + short(pk));
          } else {
            setStatus("warn", "Wallet detected, not connected");
          }
          return;
        }
        if (tries < maxTries){
          setTimeout(pollProvider, 200);
        } else {
          $("#debug-line").textContent = "Provider: NOT FOUND";
          setStatus("", "Phantom not detected");
          if (inIframe()){
            $("#openTopBtn").style.display = "inline-block";
          }
        }
      }

      async function connect(ev){
        try { ev?.preventDefault(); ev?.stopPropagation(); } catch {}
        if (!provider){ provider = getProvider(); }
        if (!provider){
          setStatus("", "Phantom not detected");
          if (inIframe()) $("#openTopBtn").style.display = "inline-block";
          return;
        }
        try{
          const resp = await provider.connect({ onlyIfTrusted: false });
          const pk = resp?.publicKey?.toString?.() || provider.publicKey?.toString?.() || null;
          if (pk){
            connectedPubkey = pk;
            $("#connectBtn").textContent = short(pk);
            $("#debug-line").textContent = "connect() resolved: " + pk;
            setStatus("ok", "Connected: " + short(pk));
          } else {
            setStatus("warn", "Wallet detected, not connected");
          }
        }catch(e){
          $("#debug-line").textContent = "connect() threw: " + (e?.message || e);
          setStatus("", "Not connected");
        }
      }

      function openTop(){
        const href = window.location.href;
        window.open(href, "_blank", "noopener");
      }

      window.addEventListener("DOMContentLoaded", () => {
        $("#connectBtn").addEventListener("click", connect, { passive:false });
        $("#openTopBtn").addEventListener("click", openTop);
        if (inIframe()) $("#openTopBtn").style.display = "inline-block";
        pollProvider();
      });
    })();
  </script>
</body>
</html>
